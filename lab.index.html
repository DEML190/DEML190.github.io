<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Ai - identify your dog's breed online</title>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="assets/css/lab.style.css">
    <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
    <!-- <script src="page-transitions/js/jquery-3.2.1.js"></script> -->
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://siteapp.baidu.com/static/webappservice/uaredirect.js" type="text/javascript"></script>
    <script type="text/javascript">uaredirect("http://120.76.143.58:8080/dogai/m.index.html");</script>

    <style>
        flydog {
            width: 200px;
            height: 200px;
            background: url(assets/img/bollon.png);
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>


    <script>
        var socket;

        function init() {
            var host = "ws://120.76.143.58:9880/";

            try {
                socket = new WebSocket(host);
                socket.onopen = function (msg) {
                    log("远程主机连接成功!");
                };
                socket.onmessage = function (msg) {
                    if (msg.data.indexOf("breed") != -1) {
                        details = eval(msg.data);
                        showResult(details);
                    } else if (msg.data == "5001") {
                        log('URL格式错误或未提供预测对象！请重新发送');
                        barShutDown = 1;
                        startBar(barShutDown);
                    } else if (msg.data == "5002") {
                        log('请等待上一提交的任务完成后再发送！');
                    }
                    else {
                        // log("Unknown Error!")
                    }
                };
                socket.onclose = function (msg) {
                    log("连接断开！如需继续请按刷新");
                };

            }
            catch (ex) {
                log(ex);
            }
            $("msg").focus();


            // show results
            function showResult() {
                //js循环读取json数据
                var table = document.getElementById("table");
                var row = table.insertRow(table.rows.length);
                var c1 = row.insertCell(0);
                var c2 = row.insertCell(1);
                c1.innerHTML = "";
                c2.innerHTML = "";
                for (var i = 0; i < 5; i++) {
                    var row = table.insertRow(table.rows.length);
                    var c1 = row.insertCell(0);
                    c1.innerHTML = details[i].prob;
                    var c2 = row.insertCell(1);
                    c2.innerHTML = details[i].breed;
                };
                log("恭喜！识别结果出来了，你的狗狗品种将显示在右方：→");
                log(" ")
            };

            // set the flying dog
            var oDiv = document.body.children[0];
            var iSpeedX = 1;
            var iSpeedY = 1;

            setInterval(function () {
                var l = oDiv.offsetLeft + iSpeedX;
                var t = oDiv.offsetTop + iSpeedY;

                if (t > document.documentElement.clientHeight - oDiv.offsetHeight) {
                    t = document.documentElement.clientHeight - oDiv.offsetHeight;
                    iSpeedY *= -1;
                }
                if (l > document.documentElement.clientWidth - oDiv.offsetWidth) {
                    l = document.documentElement.clientWidth - oDiv.offsetWidth;
                    iSpeedX *= -1;
                }

                if (t < 0) {
                    t = 0;
                    iSpeedY *= -1;
                }
                if (l < 0) {
                    l = 0;
                    iSpeedX *= -1;
                }

                oDiv.style.left = l + 'px';
                oDiv.style.top = t + 'px';
            }, 16);
        }

        function send() {
            var txt, msg;
            txt = $("msg");
            msg = txt.value;
            if (!msg) {
                alert("Message can not be empty");
                return;
            }
            txt.value = "";
            txt.focus();
            try {
                socket.send(msg);
                msg_string = String(msg)
                showImage(msg_string);

                barShutDown = 0;
                startBar(barShutDown);
                log("图片成功上传至服务器！正在进行识别... ...");
            } catch (ex) {
                log(ex);
            }
        }

        window.onbeforeunload = function () {
            try {
                socket.send('quit');
                socket.close();
                socket = null;
            }
            catch (ex) {
                log(ex);
            }
        };

        function $(id) {
            return document.getElementById(id);
        }
        function log(msg) {
            $("log").innerHTML += "<br>" + msg;

        }
        function onkey(event) {
            if (event.keyCode == 13) {
                send();
            }
        }


        function startBar() {
            var n = 0;
            var result = document.getElementById('load');
            var load = document.getElementById('load');
            var i = 0;
            var timer = setInterval(function () {
                if (barShutDown !== 1) {
                    if (i < 100) {
                        i += 0.43;
                        load.style.width = i * 8 + 'px';
                    }
                    if (i >= 100) {
                        clearInterval(timer);
                    }
                }
                else if (barShutDown == 1) {
                    clearInterval(timer);
                }
                console.log(i)
            }, 100);
        };

        function showImage() {
            $("imgs").setAttribute('src', msg_string);
            // var downloadUrl = document.getElementById("imgs");
            // downloadUrl.setAttribute('src', msg_string)
        };

    </script>

</head>

<body onload="init()">
    <div class="bgimg"></div>
    <div class="imgContainer">
        <img id='imgs' src="assets/img/ini.png" alt="">
    </div>
    <div id="log">
        <div style="color:snow;">【Terminal】</div>
        <div class="show">
            <table id="table">
                <tr style="color: snow;">
                    <th>[概率]_______</th>
                    <th>_______[品种]</th>
                </tr>
            </table>
        </div>
    </div>
    <div style="left:10%; top: 0%;">
        <div class="box" id="div_box">
            <div class="load" id="load"></div> <!--  进度条 -->
        </div>
    </div>
    <br>
    <br>
    <input id="msg" type="textbox" onkeypress="onkey(event)" />
    <button onclick="send()">发送</button>
    <input type=button value=刷新 onclick="location.replace(location)">
    <br>
    <br>
    <div>请在上方表格框输入或粘贴图片URI，点击【发送】即可获得识别结果；若有错误，请按【刷新】</div>
    <br>
    <br>
    <div class="Copyright">Copyright © 2022 lhfeng Admin</div>

</body>

</html>